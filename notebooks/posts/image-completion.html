<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nipun Batra">
<meta name="dcterms.date" content="2023-04-14">
<meta name="description" content="Image Completion using Matrix Factorization">

<title>ES654 - Image Completion using Matrix Factorization</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ES654</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../grading.html">
 <span class="menu-text">Grading Policy</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../faq.html">
 <span class="menu-text">FAQs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../schedule.html">
 <span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../quizzes.html">
 <span class="menu-text">Quizzes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../notebooks/index.html">
 <span class="menu-text">Notebooks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://nipunbatra.github.io">
 <span class="menu-text">Instructor Homepage</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Image Completion using Matrix Factorization</h1>
</div>

<div>
  <div class="description">
    Image Completion using Matrix Factorization
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nipun Batra </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 14, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'retina'</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> plt.imread(<span class="st">'dog.jpg'</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>plt.imshow(img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f060df66250&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-2-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to grayscale</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> img.mean(axis<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>plt.imshow(img, cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f060df1deb0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-3-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> img<span class="op">/</span><span class="dv">255</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>plt.imshow(img, cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f060d697c70&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-4-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MF code with missing values</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># INIT WELL!</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> factorize(A, k, niter<span class="op">=</span><span class="dv">100</span>, lr<span class="op">=</span><span class="fl">1e-3</span>):</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    n, m <span class="op">=</span> A.shape</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If we do not init well, our solution is poor</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> torch.<span class="bu">abs</span>(torch.randn(n, k)<span class="op">/</span><span class="dv">10</span>).to(A.device)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    H <span class="op">=</span> torch.<span class="bu">abs</span>(torch.randn(k, m)<span class="op">/</span><span class="dv">10</span>).to(A.device)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    W.requires_grad <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    H.requires_grad <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mask where A is not missing</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> <span class="op">~</span>torch.isnan(A).to(A.device)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(mask.shape)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam([W, H], lr<span class="op">=</span>lr)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(niter):</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        Ahat <span class="op">=</span> W <span class="op">@</span> H</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> F.mse_loss(Ahat[mask], A[mask])</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">50</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(i, loss.item())</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> W, H</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.from_numpy(img).<span class="bu">float</span>().to(device)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>W, H <span class="op">=</span> factorize(A, <span class="dv">40</span>, niter<span class="op">=</span><span class="dv">500</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([1365, 2048])
0 0.06829886883497238
10 0.01749359630048275
20 0.013666706159710884
30 0.012201043777167797
40 0.011160558089613914
50 0.009914325550198555
60 0.008142316713929176
70 0.0068585933186113834
80 0.005886096972972155
90 0.005254762712866068
100 0.004644310101866722
110 0.004189325962215662
120 0.003762295236811042
130 0.003400223096832633
140 0.0030894046649336815
150 0.0028140596114099026
160 0.002575189108029008
170 0.002369344001635909
180 0.002189089311286807
190 0.0020303716883063316
200 0.001891914987936616
210 0.0017732753185555339
220 0.0016737726982682943
230 0.001591882319189608
240 0.0015251439763233066
250 0.0014707562513649464
260 0.0014264964265748858
270 0.0013910450506955385
280 0.0013630962930619717
290 0.0013412574771791697
300 0.0013241033302620053
310 0.0013104281388223171
320 0.0012993116397410631
330 0.0012900681467726827
340 0.0012822631979361176
350 0.0012755474308505654
360 0.0012697557685896754
370 0.0012646956602111459
380 0.0012602793285623193
390 0.0012564437929540873
400 0.001253018039278686
410 0.0012500555021688342
420 0.0012474115937948227
430 0.0012450997019186616
440 0.0012430207571014762
450 0.0012411868665367365
460 0.0012395658995956182
470 0.001238090917468071
480 0.001236780546605587
490 0.0012355914805084467</code></pre>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>W<span class="op">@</span>H</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>tensor([[0.2114, 0.2170, 0.2225,  ..., 0.2079, 0.2116, 0.2141],
        [0.2113, 0.2168, 0.2222,  ..., 0.2076, 0.2112, 0.2136],
        [0.2117, 0.2171, 0.2225,  ..., 0.2066, 0.2102, 0.2125],
        ...,
        [0.3229, 0.3245, 0.3225,  ..., 0.3303, 0.3296, 0.3284],
        [0.3192, 0.3211, 0.3199,  ..., 0.3376, 0.3367, 0.3354],
        [0.3166, 0.3189, 0.3183,  ..., 0.3432, 0.3421, 0.3407]],
       device='cuda:0', grad_fn=&lt;MmBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot reconstructed image</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>plt.imshow((W <span class="op">@</span> H).cpu().detach().numpy(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f0578172490&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-9-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, remove a rectangular patch from the image</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>patch <span class="op">=</span> [<span class="dv">100</span>, <span class="dv">600</span>, <span class="dv">400</span>, <span class="dv">1000</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>img_copy <span class="op">=</span> img.copy()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># NAN the patch region</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>img_copy[patch[<span class="dv">0</span>]:patch[<span class="dv">2</span>], patch[<span class="dv">1</span>]: patch[<span class="dv">3</span>]] <span class="op">=</span> np.NaN</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(img_copy,cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f057814ebe0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.from_numpy(img_copy).<span class="bu">float</span>().to(device)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>W, H <span class="op">=</span> factorize(A, <span class="dv">40</span>, niter<span class="op">=</span><span class="dv">500</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([1365, 2048])
0 0.07003924995660782
10 0.01769193261861801
20 0.013949600048363209
30 0.01242945995181799
40 0.01138114370405674
50 0.010110059753060341
60 0.008373978547751904
70 0.007100649643689394
80 0.006054402329027653
90 0.00539542268961668
100 0.004787002224475145
110 0.004339388106018305
120 0.0039057331159710884
130 0.003520655445754528
140 0.0031704953871667385
150 0.0028561835642904043
160 0.0025887591764330864
170 0.0023648005444556475
180 0.002177545567974448
190 0.00201977975666523
200 0.0018848013132810593
210 0.0017688344232738018
220 0.001670596655458212
230 0.00158921058755368
240 0.0015228266129270196
250 0.0014693135162815452
260 0.0014267893275246024
270 0.0013936090981587768
280 0.0013681232230737805
290 0.0013486901298165321
300 0.0013338333228603005
310 0.00132232834585011
320 0.0013131353771314025
330 0.0013056261232122779
340 0.001299339928664267
350 0.0012939369771629572
360 0.0012892503291368484
370 0.0012851168867200613
380 0.0012814163928851485
390 0.0012781015830114484
400 0.0012751035392284393
410 0.001272400375455618
420 0.0012699670623987913
430 0.0012676883488893509
440 0.0012656532926484942
450 0.0012637837789952755
460 0.0012620993657037616
470 0.001260560704395175
480 0.0012591815320774913
490 0.001257911790162325</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>plt.imshow((W<span class="op">@</span>H).cpu().detach().numpy(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f057812d9a0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-12-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.from_numpy(img_copy).<span class="bu">float</span>().to(device)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>W, H <span class="op">=</span> factorize(A, <span class="dv">2000</span>, niter<span class="op">=</span><span class="dv">10000</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([1365, 2048])
0 150.97117614746094
50 0.05341056361794472
100 0.03285151720046997
150 0.02901613898575306
200 0.025218751281499863
250 0.02143346145749092
300 0.017777008935809135
350 0.014495181851089
400 0.01180704589933157
450 0.009690864011645317
500 0.008009172044694424
550 0.006648130714893341
600 0.005532505922019482
650 0.004613785073161125
700 0.0038573681376874447
750 0.003235312644392252
800 0.002723895013332367
850 0.002303040586411953
900 0.001956029562279582
950 0.0016691131750121713
1000 0.0014310750411823392
1050 0.0012328173033893108
1100 0.001066986471414566
1150 0.0009276540949940681
1200 0.0008100455161184072
1250 0.0007103134994395077
1300 0.0006253537721931934
1350 0.0005526544991880655
1400 0.0004901768988929689
1450 0.0004362595791462809
1500 0.00038954304181970656
1550 0.00034891001996584237
1600 0.0003134383005090058
1650 0.0002823633549269289
1700 0.0002550485369283706
1750 0.00023096162476576865
1800 0.00020965580188203603
1850 0.00019075443560723215
1900 0.00017393901362083852
1950 0.00015893897216301411
2000 0.00014552375068888068
2050 0.00013349624350667
2100 0.00012268732825759798
2150 0.00011295141302980483
2200 0.00010416284203529358
2250 9.621278150007129e-05
2300 8.900670945877209e-05
2350 8.246232027886435e-05
2400 7.650776387890801e-05
2450 7.10801177774556e-05
2500 6.612417928408831e-05
2550 6.159136682981625e-05
2600 5.743886504205875e-05
2650 5.362883894122206e-05
2700 5.012777182855643e-05
2750 4.690593414125033e-05
2800 4.393686685943976e-05
2850 4.1197024984285235e-05
2900 3.866538463626057e-05
2950 3.632314474089071e-05
3000 3.415345054236241e-05
3050 3.2141204428626224e-05
3100 3.0272811272880062e-05
3150 2.8536049285321496e-05
3200 2.6919889933196828e-05
3250 2.5414365154574625e-05
3300 2.401047822786495e-05
3350 2.270007462357171e-05
3400 2.1475751054822467e-05
3450 2.0330777260824107e-05
3500 1.9259052351117134e-05
3550 1.8255008399137296e-05
3600 1.7313568605459295e-05
3650 1.643009454710409e-05
3700 1.5600355254719034e-05
3750 1.4820473552390467e-05
3800 1.4086899682297371e-05
3850 1.3396372196439188e-05
3900 1.2745897947752383e-05
3950 1.2132728443248197e-05
4000 1.1554336197150405e-05
4050 1.1008387446054257e-05
4100 1.0492732144484762e-05
4150 1.0005393960454967e-05
4200 9.544532076688483e-06
4250 9.108456652029417e-06
4300 8.695598808117211e-06
4350 8.304504262923729e-06
4400 7.933832421258558e-06
4450 7.582332273159409e-06
4500 7.248837391671259e-06
4550 6.9322791205195244e-06
4600 6.631650649069343e-06
4650 6.34601610727259e-06
4700 6.074509656173177e-06
4750 5.816319571749773e-06
4800 5.570689154410502e-06
4850 5.3369126362667885e-06
4900 5.11432699568104e-06
4950 4.902320142718963e-06
5000 4.700310000771424e-06
5050 4.50775723948027e-06
5100 4.324154815549264e-06
5150 4.149028882238781e-06
5200 3.981928784924094e-06
5250 3.822439339273842e-06
5300 3.6701676435768604e-06
5350 3.524737849147641e-06
5400 3.385807303857291e-06
5450 3.2530431326449616e-06
5500 3.1261370168067515e-06
5550 3.0047970085433917e-06
5600 2.8887482130812714e-06
5650 2.7777321065514116e-06
5700 2.6715015337686054e-06
5750 2.5698252557049273e-06
5800 2.4724829472688725e-06
5850 2.3792699721525423e-06
5900 2.2899866962688975e-06
5950 2.2044491743145045e-06
6000 2.1224793727014912e-06
6050 2.0439129002625123e-06
6100 1.9685905954247573e-06
6150 1.8963601178256795e-06
6200 1.8270810642206925e-06
6250 1.760620079949149e-06
6300 1.6968460840871558e-06
6350 1.635640273889294e-06
6400 1.5768823686812539e-06
6450 1.5204675491986563e-06
6500 1.4662883813798544e-06
6550 1.414246071362868e-06
6600 1.364247509627603e-06
6650 1.316200609835505e-06
6700 1.2700223805950372e-06
6750 1.2256310810698778e-06
6800 1.1829495178972138e-06
6850 1.1419036809456884e-06
6900 1.102423198062752e-06
6950 1.0644417898220127e-06
7000 1.027897269523237e-06
7050 9.927267683451646e-07
7100 9.588746934241499e-07
7150 9.262849403057771e-07
7200 8.949060656959773e-07
7250 8.646877063256397e-07
7300 8.355830232176231e-07
7350 8.075453479250427e-07
7400 7.805318773534964e-07
7450 7.545020821453363e-07
7500 7.294156034731714e-07
7550 7.052357204884174e-07
7600 6.819264513069356e-07
7650 6.594532351300586e-07
7700 6.377832733051036e-07
7750 6.168849608911842e-07
7800 5.967290235275868e-07
7850 5.772870395048812e-07
7900 5.585311555478256e-07
7950 5.404351668403251e-07
8000 5.229745738688507e-07
8050 5.061245360593603e-07
8100 4.898624297311471e-07
8150 4.7416742177119886e-07
8200 4.590159221606882e-07
8250 4.44389627318742e-07
8300 4.3026821572311746e-07
8350 4.1663423644422437e-07
8400 4.034685332499066e-07
8450 3.907547636572417e-07
8500 3.7847598832740914e-07
8550 3.666165184768033e-07
8600 3.551611769125884e-07
8650 3.44094615911672e-07
8700 3.334033920054935e-07
8750 3.230740901472018e-07
8800 3.130932100248174e-07
8850 3.0344827450790035e-07
8900 2.941270622613956e-07
8950 2.8511848881862534e-07
9000 2.764106739050476e-07
9050 2.679938972960372e-07
9100 2.598564776690182e-07
9150 2.519889221730409e-07
9200 2.443812263663858e-07
9250 2.370250768990445e-07
9300 2.2991073933553707e-07
9350 2.2302984348243626e-07
9400 2.1637396230289596e-07
9450 2.0993516613998509e-07
9500 2.0370568165617442e-07
9550 1.976784460566705e-07
9600 1.9184577126907243e-07
9650 1.862013192521772e-07
9700 1.8073811247631966e-07
9750 1.7545029606935714e-07
9800 1.703306367062396e-07
9850 1.653745158591846e-07
9900 1.605755244327156e-07
9950 1.5592880231452e-07</code></pre>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plt.imshow((W<span class="op">@</span>H).cpu().detach().numpy(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f057043c0a0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>img_copy_mar <span class="op">=</span> img.copy()</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Mask 50% of the values</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> np.random.rand(<span class="op">*</span>img_copy_mar.shape) <span class="op">&lt;</span> <span class="fl">0.5</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>img_copy_mar[mask] <span class="op">=</span> np.NaN</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(img_copy_mar, cmap<span class="op">=</span><span class="st">'gray'</span>, interpolation<span class="op">=</span><span class="st">'none'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f04f4a99e50&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.from_numpy(img_copy_mar).<span class="bu">float</span>().to(device)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>W, H <span class="op">=</span> factorize(A, <span class="dv">40</span>, niter<span class="op">=</span><span class="dv">500</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([1365, 2048])
0 0.06834408640861511
50 0.009696380235254765
100 0.004485020879656076
150 0.002751269144937396
200 0.001827028812840581
250 0.0014045980060473084
300 0.0012345635332167149
350 0.001172593212686479
400 0.0011480636894702911
450 0.001136348000727594</code></pre>
</div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>plt.imshow((W<span class="op">@</span>H).cpu().detach().numpy(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f04f4a151c0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-17-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>img_copy_mar <span class="op">=</span> img.copy()</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Mask 95% of the values</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> np.random.rand(<span class="op">*</span>img_copy_mar.shape) <span class="op">&lt;</span> <span class="fl">0.90</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>img_copy_mar[mask] <span class="op">=</span> np.NaN</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>plt.imshow(img_copy_mar, cmap<span class="op">=</span><span class="st">'gray'</span>, interpolation<span class="op">=</span><span class="st">'none'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f04ec72f310&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-18-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.from_numpy(img_copy_mar).<span class="bu">float</span>().to(device)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>W, H <span class="op">=</span> factorize(A, <span class="dv">12</span>, niter<span class="op">=</span><span class="dv">5000</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([1365, 2048])
0 0.16524310410022736
50 0.011408291757106781
100 0.010492468252778053
150 0.007313533686101437
200 0.005183914676308632
250 0.00427259411662817
300 0.003722510999068618
350 0.0034131277352571487
400 0.003222056897357106
450 0.0030949581414461136
500 0.0030100212898105383
550 0.00295196077786386
600 0.00291002937592566
650 0.002877690363675356
700 0.002851426601409912
750 0.0028294965159147978
800 0.0028110460843890905
850 0.0027956736739724874
900 0.002783292206004262
950 0.002773684449493885
1000 0.0027662254869937897
1050 0.0027602335903793573
1100 0.002755254739895463
1150 0.002751055173575878
1200 0.002747524296864867
1250 0.0027445885352790356
1300 0.002742170123383403
1350 0.0027401773259043694
1400 0.0027385170105844736
1450 0.002737109549343586
1500 0.002735892776399851
1550 0.0027348219882696867
1600 0.0027338655199855566
1650 0.0027330005541443825
1700 0.002732211723923683
1750 0.0027314850594848394
1800 0.002730810549110174
1850 0.002730181673541665
1900 0.0027295963373035192
1950 0.002729057800024748
2000 0.0027285716496407986
2050 0.0027281453367322683
2100 0.0027277832850813866
2150 0.0027274840977042913
2200 0.002727244049310684
2250 0.0027270542923361063
2300 0.002726905979216099
2350 0.002726790262386203
2400 0.0027266989927738905
2450 0.002726626815274358
2500 0.0027265683747828007
2550 0.0027265208773314953
2600 0.002726481994614005
2650 0.0027264493983238935
2700 0.0027264219243079424
2750 0.0027263984084129333
2800 0.002726377919316292
2850 0.0027263606898486614
2900 0.0027263450901955366
2950 0.0027263315860182047
3000 0.0027263194788247347
3050 0.002726308535784483
3100 0.002726298524066806
3150 0.0027262892108410597
3200 0.002726281527429819
3250 0.002726274076849222
3300 0.0027262675575912
3350 0.002726261503994465
3400 0.002726256148889661
3450 0.0027262514922767878
3500 0.0027262470684945583
3550 0.0027262435760349035
3600 0.0027262403164058924
3650 0.002726237755268812
3700 0.002726235194131732
3750 0.0027262333314865828
3800 0.002726231701672077
3850 0.002726230537518859
3900 0.002726229140534997
3950 0.0027262282092124224
4000 0.002726227743551135
4050 0.002726227045059204
4100 0.002726226579397917
4150 0.002726226346567273
4200 0.0027262261137366295
4250 0.002726225648075342
4300 0.002726225648075342
4350 0.002726225648075342
4400 0.002726225182414055
4450 0.0027262254152446985
4500 0.002726225182414055
4550 0.002726225182414055
4600 0.002726225182414055
4650 0.002726225182414055
4700 0.002726225182414055
4750 0.002726225182414055
4800 0.002726225182414055
4850 0.002726225182414055
4900 0.002726225182414055
4950 0.002726225182414055</code></pre>
</div>
</div>
<div class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>plt.imshow((W<span class="op">@</span>H).cpu().detach().numpy(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f04ec4cc640&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="image-completion_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>